/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const K=Symbol("Comlink.proxy"),it=Symbol("Comlink.endpoint"),ot=Symbol("Comlink.releaseProxy"),G=Symbol("Comlink.finalizer"),B=Symbol("Comlink.thrown"),Z=t=>typeof t=="object"&&t!==null||typeof t=="function",ct={canHandle:t=>Z(t)&&t[K],serialize(t){const{port1:n,port2:s}=new MessageChannel;return Q(t,n),[s,[s]]},deserialize(t){return t.start(),ft(t)}},lt={canHandle:t=>Z(t)&&B in t,serialize({value:t}){let n;return t instanceof Error?n={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:n={isError:!1,value:t},[n,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},tt=new Map([["proxy",ct],["throw",lt]]);function mt(t,n){for(const s of t)if(n===s||s==="*"||s instanceof RegExp&&s.test(n))return!0;return!1}function Q(t,n=globalThis,s=["*"]){n.addEventListener("message",function i(a){if(!a||!a.data)return;if(!mt(s,a.origin)){console.warn(`Invalid origin '${a.origin}' for comlink proxy`);return}const{id:r,type:f,path:h}=Object.assign({path:[]},a.data),m=(a.data.argumentList||[]).map(v);let o;try{const l=h.slice(0,-1).reduce((c,g)=>c[g],t),u=h.reduce((c,g)=>c[g],t);switch(f){case"GET":o=u;break;case"SET":l[h.slice(-1)[0]]=v(a.data.value),o=!0;break;case"APPLY":o=u.apply(l,m);break;case"CONSTRUCT":{const c=new u(...m);o=xt(c)}break;case"ENDPOINT":{const{port1:c,port2:g}=new MessageChannel;Q(t,g),o=k(c,[c])}break;case"RELEASE":o=void 0;break;default:return}}catch(l){o={value:l,[B]:0}}Promise.resolve(o).catch(l=>({value:l,[B]:0})).then(l=>{const[u,c]=V(l);n.postMessage(Object.assign(Object.assign({},u),{id:r}),c),f==="RELEASE"&&(n.removeEventListener("message",i),et(n),G in t&&typeof t[G]=="function"&&t[G]())}).catch(l=>{const[u,c]=V({value:new TypeError("Unserializable return value"),[B]:0});n.postMessage(Object.assign(Object.assign({},u),{id:r}),c)})}),n.start&&n.start()}function ht(t){return t.constructor.name==="MessagePort"}function et(t){ht(t)&&t.close()}function ft(t,n){const s=new Map;return t.addEventListener("message",function(a){const{data:r}=a;if(!r||!r.id)return;const f=s.get(r.id);if(f)try{f(r)}finally{s.delete(r.id)}}),q(t,s,[],n)}function L(t){if(t)throw new Error("Proxy has been released and is not useable")}function nt(t){return z(t,new Map,{type:"RELEASE"}).then(()=>{et(t)})}const _=new WeakMap,D="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const n=(_.get(t)||0)-1;_.set(t,n),n===0&&nt(t)});function ut(t,n){const s=(_.get(n)||0)+1;_.set(n,s),D&&D.register(t,n,t)}function gt(t){D&&D.unregister(t)}function q(t,n,s=[],i=function(){}){let a=!1;const r=new Proxy(i,{get(f,h){if(L(a),h===ot)return()=>{gt(r),nt(t),n.clear(),a=!0};if(h==="then"){if(s.length===0)return{then:()=>r};const m=z(t,n,{type:"GET",path:s.map(o=>o.toString())}).then(v);return m.then.bind(m)}return q(t,n,[...s,h])},set(f,h,m){L(a);const[o,l]=V(m);return z(t,n,{type:"SET",path:[...s,h].map(u=>u.toString()),value:o},l).then(v)},apply(f,h,m){L(a);const o=s[s.length-1];if(o===it)return z(t,n,{type:"ENDPOINT"}).then(v);if(o==="bind")return q(t,n,s.slice(0,-1));const[l,u]=X(m);return z(t,n,{type:"APPLY",path:s.map(c=>c.toString()),argumentList:l},u).then(v)},construct(f,h){L(a);const[m,o]=X(h);return z(t,n,{type:"CONSTRUCT",path:s.map(l=>l.toString()),argumentList:m},o).then(v)}});return ut(r,t),r}function dt(t){return Array.prototype.concat.apply([],t)}function X(t){const n=t.map(V);return[n.map(s=>s[0]),dt(n.map(s=>s[1]))]}const at=new WeakMap;function k(t,n){return at.set(t,n),t}function xt(t){return Object.assign(t,{[K]:!0})}function V(t){for(const[n,s]of tt)if(s.canHandle(t)){const[i,a]=s.serialize(t);return[{type:"HANDLER",name:n,value:i},a]}return[{type:"RAW",value:t},at.get(t)||[]]}function v(t){switch(t.type){case"HANDLER":return tt.get(t.name).deserialize(t.value);case"RAW":return t.value}}function z(t,n,s,i){return new Promise(a=>{const r=Mt();n.set(r,a),t.start&&t.start(),t.postMessage(Object.assign({id:r},s),i)})}function Mt(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const e={naturalW:0,naturalH:0,scale:1,canvasW:0,canvasH:0,insets:{top:0,right:0,bottom:0,left:0},mode:"9-part",centerMode:"stretch"};function st(){if(!e.canvas)throw new Error("Canvas not attached");if(!e.ctx){const t=e.canvas.getContext("2d",{alpha:!0});if(!t)throw new Error("2D context unavailable");e.ctx=t}return e.ctx}function J(){e.img&&(e.canvasW=Math.max(1,Math.round(e.naturalW/e.scale)),e.canvasH=Math.max(1,Math.round(e.naturalH/e.scale)),e.canvas&&(e.canvas.width=e.canvasW,e.canvas.height=e.canvasH),rt())}function rt(t="right",n="bottom"){e.insets.left=Math.max(0,Math.min(e.insets.left,e.canvasW-1)),e.insets.right=Math.max(0,Math.min(e.insets.right,e.canvasW-1)),e.insets.top=Math.max(0,Math.min(e.insets.top,e.canvasH-1)),e.insets.bottom=Math.max(0,Math.min(e.insets.bottom,e.canvasH-1)),e.insets.left+e.insets.right>=e.canvasW&&(t!=="left"?e.insets.right=Math.max(0,e.canvasW-e.insets.left-1):e.insets.left=Math.max(0,e.canvasW-e.insets.right-1)),e.insets.top+e.insets.bottom>=e.canvasH&&(n!=="bottom"?e.insets.top=Math.max(0,e.canvasH-e.insets.bottom-1):e.insets.bottom=Math.max(0,e.canvasH-e.insets.top-1))}function pt(t,n,s){for(let a=0;a<s;a+=8)for(let r=0;r<n;r+=8)t.fillStyle=(r/8+a/8)%2===0?"#eee":"#ddd",t.fillRect(r,a,8,8)}function N(){const t=st(),{canvasW:n,canvasH:s}=e;t.clearRect(0,0,n,s),pt(t,n,s),e.img&&(t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high",t.drawImage(e.img,0,0,e.naturalW,e.naturalH,0,0,n,s)),t.save(),t.setLineDash([6,4]),t.lineWidth=1,e.mode!=="3-part-vertical"&&(t.strokeStyle="#007aff",t.beginPath(),t.moveTo(e.insets.left,0),t.lineTo(e.insets.left,s),t.moveTo(n-e.insets.right,0),t.lineTo(n-e.insets.right,s),t.stroke()),e.mode!=="3-part-horizontal"&&(t.strokeStyle="#ff3b30",t.beginPath(),t.moveTo(0,e.insets.top),t.lineTo(n,e.insets.top),t.moveTo(0,s-e.insets.bottom),t.lineTo(n,s-e.insets.bottom),t.stroke());const i=e.insets.left,a=e.insets.top,r=Math.max(0,n-e.insets.left-e.insets.right),f=Math.max(0,s-e.insets.top-e.insets.bottom);t.fillStyle="rgba(0, 122, 255, 0.08)",t.fillRect(i,a,r,f),t.fillStyle="#000",t.font="12px system-ui, -apple-system, sans-serif",t.textAlign="left",t.textBaseline="top",t.fillText(`mode=${e.mode}, center=${e.centerMode}, scale=${e.scale}x`,6,6),t.restore()}function yt(t,n){return[{e:"left",v:Math.abs(t-e.insets.left)},{e:"right",v:Math.abs(t-(e.canvasW-e.insets.right))},{e:"top",v:Math.abs(n-e.insets.top)},{e:"bottom",v:Math.abs(n-(e.canvasH-e.insets.bottom))}].sort((i,a)=>i.v-a.v)[0].e}const bt={async attach(t){e.canvas=t,e.ctx=void 0,st()},async setSource(t,n){e.img&&e.img.close(),e.img=t,e.naturalW=t.width,e.naturalH=t.height,e.scale=n,J(),N()},async setScale(t){e.scale=t,J(),N()},async setMode(t,n){e.mode=t,e.centerMode=n,N()},async setInsets(t,n="right",s="bottom"){e.insets={...e.insets,...t},rt(n,s),N()},async queryNearestEdge(t,n){return yt(t,n)},async getState(){return{canvasW:e.canvasW,canvasH:e.canvasH,insets:e.insets,scale:e.scale,mode:e.mode,centerMode:e.centerMode,naturalW:e.naturalW,naturalH:e.naturalH}},async buildResizingInfo(t){const n=Math.round(e.naturalW/e.scale)*t,s=Math.round(e.naturalH/e.scale)*t,i=e.insets,a=Math.max(0,n-i.left*t-i.right*t),r=Math.max(0,s-i.top*t-i.bottom*t);return e.mode==="3-part-horizontal"?{mode:"3-part-horizontal",center:{mode:e.centerMode,width:a},"cap-insets":{left:i.left*t,right:i.right*t}}:e.mode==="3-part-vertical"?{mode:"3-part-vertical",center:{mode:e.centerMode,height:r},"cap-insets":{top:i.top*t,bottom:i.bottom*t}}:{mode:"9-part",center:{mode:e.centerMode,width:a,height:r},"cap-insets":{left:i.left*t,right:i.right*t,top:i.top*t,bottom:i.bottom*t}}},async exportAsset(t){const n=await this.buildResizingInfo(1),s=await this.buildResizingInfo(2),i=await this.buildResizingInfo(3),a=new OffscreenCanvas(e.naturalW/e.scale*3,e.naturalH/e.scale*3);let r=a.getContext("2d");r.drawImage(e.img,0,0,e.img.width,e.img.height,0,0,a.width,a.height);const f=await a.convertToBlob({type:"image/png"});a.width=a.width*2/3,a.height=a.height*2/3,r=a.getContext("2d"),r.drawImage(e.img,0,0,e.img.width,e.img.height,0,0,a.width,a.height);const h=await a.convertToBlob({type:"image/png"});a.width/=2,a.height/=2,r=a.getContext("2d"),r.drawImage(e.img,0,0,e.img.width,e.img.height,0,0,a.width,a.height);const m=await a.convertToBlob({type:"image/png"});return{contents:{images:[{filename:`${t}@1x.png`,idiom:"universal",scale:"1x",resizing:n},{filename:`${t}@2x.png`,idiom:"universal",scale:"2x",resizing:s},{filename:`${t}@3x.png`,idiom:"universal",scale:"3x",resizing:i}],info:{version:1,author:"pbk"}},image1x:m,image2x:h,image3x:f}},async createBitmap(t,n){let s=new OffscreenCanvas(t,n);if(s.getContext("2d",{alpha:!0}),!e.img)return null;await this.renderOn(s,0,0,t,n);let r=s.transferToImageBitmap();return k(r,[r])},async renderOn(t,n,s,i,a){const r=t.getContext("2d",{alpha:!0});if(!r)return k(t,[t]);if(!e.img)return k(t,[t]);const f=Math.max(1,Math.round(e.naturalW/e.scale)),h=Math.max(1,Math.round(e.naturalH/e.scale));let{left:m,right:o,top:l,bottom:u}=e.insets;e.mode==="3-part-horizontal"&&(l=0,u=0),e.mode==="3-part-vertical"&&(m=0,o=0),m=Math.max(0,Math.min(m,f-1)),o=Math.max(0,Math.min(o,f-1)),l=Math.max(0,Math.min(l,h-1)),u=Math.max(0,Math.min(u,h-1)),m+o>=f&&(o=Math.max(0,f-m-1)),l+u>=h&&(u=Math.max(0,h-l-1));let c=Math.min(m,Math.max(0,i)),g=Math.min(o,Math.max(0,i-c)),d=Math.min(l,Math.max(0,a)),x=Math.min(u,Math.max(0,a-d)),M=Math.max(0,i-c-g),p=Math.max(0,a-d-x);c+M+g!==i&&(g=Math.max(0,i-c-M)),d+p+x!==a&&(x=Math.max(0,a-d-p));const E=e.scale,b=m*E,H=o*E,w=l*E,W=u*E,$=e.naturalW,F=e.naturalH,R=Math.max(0,(f-m-o)*E),S=Math.max(0,(h-l-u)*E),y=(j,U,P,I,O,A,T,C)=>{P<=0||I<=0||T<=0||C<=0||r.drawImage(e.img,j,U,P,I,n+O,s+A,T,C)};if(y(0,0,b,w,0,0,c,d),y($-H,0,H,w,i-g,0,g,d),y(0,F-W,b,W,0,a-x,c,x),y($-H,F-W,H,W,i-g,a-x,g,x),d>0&&M>0&&e.mode!=="3-part-horizontal"&&y(b,0,R,w,c,0,M,d),x>0&&M>0&&e.mode!=="3-part-horizontal"&&y(b,F-W,R,W,c,a-x,M,x),c>0&&p>0&&e.mode!=="3-part-vertical"&&y(0,w,b,S,0,d,c,p),g>0&&p>0&&e.mode!=="3-part-vertical"&&y($-H,w,H,S,i-g,d,g,p),M>0&&p>0)if(e.centerMode==="stretch")y(b,w,R,S,c,d,M,p);else{const j=Math.max(0,f-m-o),U=Math.max(0,h-l-u),P=i/f,I=a/h,O=Math.max(1,Math.round(j*P)),A=Math.max(1,Math.round(U*I)),T=new OffscreenCanvas(O,A),C=T.getContext("2d",{alpha:!0});C.imageSmoothingEnabled=!0,C.imageSmoothingQuality="high",C.drawImage(e.img,b,w,R,S,0,0,O,A);const Y=r.createPattern(T,"repeat");Y&&(r.save(),r.translate(n+c,s+d),r.fillStyle=Y,r.fillRect(0,0,M,p),r.restore())}return k(t,[t])}};Q(bt);
