/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const et=Symbol("Comlink.proxy"),ht=Symbol("Comlink.endpoint"),mt=Symbol("Comlink.releaseProxy"),Y=Symbol("Comlink.finalizer"),L=Symbol("Comlink.thrown"),nt=t=>typeof t=="object"&&t!==null||typeof t=="function",ft={canHandle:t=>nt(t)&&t[et],serialize(t){const{port1:n,port2:a}=new MessageChannel;return J(t,n),[a,[a]]},deserialize(t){return t.start(),pt(t)}},ut={canHandle:t=>nt(t)&&L in t,serialize({value:t}){let n;return t instanceof Error?n={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:n={isError:!1,value:t},[n,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},at=new Map([["proxy",ft],["throw",ut]]);function gt(t,n){for(const a of t)if(n===a||a==="*"||a instanceof RegExp&&a.test(n))return!0;return!1}function J(t,n=globalThis,a=["*"]){n.addEventListener("message",function i(r){if(!r||!r.data)return;if(!gt(a,r.origin)){console.warn(`Invalid origin '${r.origin}' for comlink proxy`);return}const{id:s,type:m,path:o}=Object.assign({path:[]},r.data),f=(r.data.argumentList||[]).map(y);let c;try{const h=o.slice(0,-1).reduce((l,g)=>l[g],t),u=o.reduce((l,g)=>l[g],t);switch(m){case"GET":c=u;break;case"SET":h[o.slice(-1)[0]]=y(r.data.value),c=!0;break;case"APPLY":c=u.apply(h,f);break;case"CONSTRUCT":{const l=new u(...f);c=bt(l)}break;case"ENDPOINT":{const{port1:l,port2:g}=new MessageChannel;J(t,g),c=S(l,[l])}break;case"RELEASE":c=void 0;break;default:return}}catch(h){c={value:h,[L]:0}}Promise.resolve(c).catch(h=>({value:h,[L]:0})).then(h=>{const[u,l]=B(h);n.postMessage(Object.assign(Object.assign({},u),{id:s}),l),m==="RELEASE"&&(n.removeEventListener("message",i),rt(n),Y in t&&typeof t[Y]=="function"&&t[Y]())}).catch(h=>{const[u,l]=B({value:new TypeError("Unserializable return value"),[L]:0});n.postMessage(Object.assign(Object.assign({},u),{id:s}),l)})}),n.start&&n.start()}function dt(t){return t.constructor.name==="MessagePort"}function rt(t){dt(t)&&t.close()}function pt(t,n){const a=new Map;return t.addEventListener("message",function(r){const{data:s}=r;if(!s||!s.id)return;const m=a.get(s.id);if(m)try{m(s)}finally{a.delete(s.id)}}),X(t,a,[],n)}function O(t){if(t)throw new Error("Proxy has been released and is not useable")}function st(t){return W(t,new Map,{type:"RELEASE"}).then(()=>{rt(t)})}const _=new WeakMap,N="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const n=(_.get(t)||0)-1;_.set(t,n),n===0&&st(t)});function xt(t,n){const a=(_.get(n)||0)+1;_.set(n,a),N&&N.register(t,n,t)}function Mt(t){N&&N.unregister(t)}function X(t,n,a=[],i=function(){}){let r=!1;const s=new Proxy(i,{get(m,o){if(O(r),o===mt)return()=>{Mt(s),st(t),n.clear(),r=!0};if(o==="then"){if(a.length===0)return{then:()=>s};const f=W(t,n,{type:"GET",path:a.map(c=>c.toString())}).then(y);return f.then.bind(f)}return X(t,n,[...a,o])},set(m,o,f){O(r);const[c,h]=B(f);return W(t,n,{type:"SET",path:[...a,o].map(u=>u.toString()),value:c},h).then(y)},apply(m,o,f){O(r);const c=a[a.length-1];if(c===ht)return W(t,n,{type:"ENDPOINT"}).then(y);if(c==="bind")return X(t,n,a.slice(0,-1));const[h,u]=Z(f);return W(t,n,{type:"APPLY",path:a.map(l=>l.toString()),argumentList:h},u).then(y)},construct(m,o){O(r);const[f,c]=Z(o);return W(t,n,{type:"CONSTRUCT",path:a.map(h=>h.toString()),argumentList:f},c).then(y)}});return xt(s,t),s}function yt(t){return Array.prototype.concat.apply([],t)}function Z(t){const n=t.map(B);return[n.map(a=>a[0]),yt(n.map(a=>a[1]))]}const it=new WeakMap;function S(t,n){return it.set(t,n),t}function bt(t){return Object.assign(t,{[et]:!0})}function B(t){for(const[n,a]of at)if(a.canHandle(t)){const[i,r]=a.serialize(t);return[{type:"HANDLER",name:n,value:i},r]}return[{type:"RAW",value:t},it.get(t)||[]]}function y(t){switch(t.type){case"HANDLER":return at.get(t.name).deserialize(t.value);case"RAW":return t.value}}function W(t,n,a,i){return new Promise(r=>{const s=wt();n.set(s,r),t.start&&t.start(),t.postMessage(Object.assign({id:s},a),i)})}function wt(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const e={naturalW:0,naturalH:0,scale:1,canvasW:0,canvasH:0,insets:{top:0,right:0,bottom:0,left:0},mode:"9-part",centerMode:"stretch"};function ot(){if(!e.canvas)throw new Error("Canvas not attached");if(!e.ctx){const t=e.canvas.getContext("2d",{alpha:!0});if(!t)throw new Error("2D context unavailable");e.ctx=t}return e.ctx}function tt(){e.img&&(e.canvasW=Math.max(1,Math.round(e.naturalW/e.scale)),e.canvasH=Math.max(1,Math.round(e.naturalH/e.scale)),e.canvas&&(e.canvas.width=e.canvasW,e.canvas.height=e.canvasH),ct())}function ct(t="right",n="bottom"){e.insets.left=Math.max(0,Math.min(e.insets.left,e.canvasW-1)),e.insets.right=Math.max(0,Math.min(e.insets.right,e.canvasW-1)),e.insets.top=Math.max(0,Math.min(e.insets.top,e.canvasH-1)),e.insets.bottom=Math.max(0,Math.min(e.insets.bottom,e.canvasH-1)),e.insets.left+e.insets.right>=e.canvasW&&(t!=="left"?e.insets.right=Math.max(0,e.canvasW-e.insets.left-1):e.insets.left=Math.max(0,e.canvasW-e.insets.right-1)),e.insets.top+e.insets.bottom>=e.canvasH&&(n!=="bottom"?e.insets.top=Math.max(0,e.canvasH-e.insets.bottom-1):e.insets.bottom=Math.max(0,e.canvasH-e.insets.top-1))}function vt(t,n,a){for(let r=0;r<a;r+=8)for(let s=0;s<n;s+=8)t.fillStyle=(s/8+r/8)%2===0?"#eee":"#ddd",t.fillRect(s,r,8,8)}function A(){const t=ot(),{canvasW:n,canvasH:a}=e;t.clearRect(0,0,n,a),vt(t,n,a),e.img&&(t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high",t.drawImage(e.img,0,0,e.naturalW,e.naturalH,0,0,n,a)),t.save(),t.setLineDash([6,4]),t.lineWidth=1,e.mode!=="3-part-vertical"&&(t.strokeStyle="#007aff",t.beginPath(),t.moveTo(e.insets.left,0),t.lineTo(e.insets.left,a),t.moveTo(n-e.insets.right,0),t.lineTo(n-e.insets.right,a),t.stroke()),e.mode!=="3-part-horizontal"&&(t.strokeStyle="#ff3b30",t.beginPath(),t.moveTo(0,e.insets.top),t.lineTo(n,e.insets.top),t.moveTo(0,a-e.insets.bottom),t.lineTo(n,a-e.insets.bottom),t.stroke()),t.fillStyle="#000",t.font="12px system-ui, -apple-system, sans-serif",t.textAlign="left",t.textBaseline="top",t.fillText(`mode=${e.mode}, center=${e.centerMode}, scale=${e.scale}x`,6,6),t.restore()}function Et(t,n){return[{e:"left",v:Math.abs(t-e.insets.left)},{e:"right",v:Math.abs(t-(e.canvasW-e.insets.right))},{e:"top",v:Math.abs(n-e.insets.top)},{e:"bottom",v:Math.abs(n-(e.canvasH-e.insets.bottom))}].sort((i,r)=>i.v-r.v)[0].e}const Ht={async attach(t){e.canvas=t,e.ctx=void 0,ot()},async setSource(t,n){e.img&&e.img.close(),e.img=t,e.naturalW=t.width,e.naturalH=t.height,e.scale=n,tt(),A()},async setScale(t){e.scale=t,tt(),A()},async setMode(t,n){e.mode=t,e.centerMode=n,A()},async setInsets(t,n="right",a="bottom"){e.insets={...e.insets,...t},ct(n,a),A()},async queryNearestEdge(t,n){return Et(t,n)},async getState(){return{canvasW:e.canvasW,canvasH:e.canvasH,insets:e.insets,scale:e.scale,mode:e.mode,centerMode:e.centerMode,naturalW:e.naturalW,naturalH:e.naturalH}},async buildResizingInfo(t){const n=Math.round(e.naturalW/e.scale)*t,a=Math.round(e.naturalH/e.scale)*t,i=e.insets,r=Math.max(0,n-i.left*t-i.right*t),s=Math.max(0,a-i.top*t-i.bottom*t);if(e.mode==="3-part-horizontal"){const o={mode:"3-part-horizontal",center:{mode:e.centerMode,width:r-1},"cap-insets":{left:i.left*t,right:i.right*t}};return o.center.width<0&&(o.center.width=0),o}if(e.mode==="3-part-vertical"){const o={mode:"3-part-vertical",center:{mode:e.centerMode,height:s-1},"cap-insets":{top:i.top*t,bottom:i.bottom*t}};return o.center.height<0&&(o.center.height=0),o}const m={mode:"9-part",center:{mode:e.centerMode,width:r-1,height:s-1},"cap-insets":{left:i.left*t,right:i.right*t,top:i.top*t,bottom:i.bottom*t}};return m.center.height<0&&(m.center.height=0),m.center.width<0&&(m.center.width=0),m},async exportAsset(t){const n=await this.buildResizingInfo(1),a=await this.buildResizingInfo(2),i=await this.buildResizingInfo(3),r=new OffscreenCanvas(e.naturalW/e.scale*3,e.naturalH/e.scale*3);let s=r.getContext("2d");s.drawImage(e.img,0,0,e.img.width,e.img.height,0,0,r.width,r.height);const m=await r.convertToBlob({type:"image/png"});r.width=r.width*2/3,r.height=r.height*2/3,s=r.getContext("2d"),s.drawImage(e.img,0,0,e.img.width,e.img.height,0,0,r.width,r.height);const o=await r.convertToBlob({type:"image/png"});r.width/=2,r.height/=2,s=r.getContext("2d"),s.drawImage(e.img,0,0,e.img.width,e.img.height,0,0,r.width,r.height);const f=await r.convertToBlob({type:"image/png"});return{contents:{images:[{filename:`${t}@1x.png`,idiom:"universal",scale:"1x",resizing:n},{filename:`${t}@2x.png`,idiom:"universal",scale:"2x",resizing:a},{filename:`${t}@3x.png`,idiom:"universal",scale:"3x",resizing:i}],info:{version:1,author:"pbk"}},image1x:f,image2x:o,image3x:m}},async createBitmap(t,n){let a=new OffscreenCanvas(t,n);if(a.getContext("2d",{alpha:!0}),!e.img)return null;await this.renderOn(a,0,0,t,n);let s=a.transferToImageBitmap();return S(s,[s])},async renderOn(t,n,a,i,r){const s=t.getContext("2d",{alpha:!0});if(!s)return S(t,[t]);if(!e.img)return S(t,[t]);const m=Math.max(1,Math.round(e.naturalW/e.scale)),o=Math.max(1,Math.round(e.naturalH/e.scale));let{left:f,right:c,top:h,bottom:u}=e.insets;e.mode==="3-part-horizontal"&&(h=0,u=0),e.mode==="3-part-vertical"&&(f=0,c=0),f=Math.max(0,Math.min(f,m-1)),c=Math.max(0,Math.min(c,m-1)),h=Math.max(0,Math.min(h,o-1)),u=Math.max(0,Math.min(u,o-1)),f+c>=m&&(c=Math.max(0,m-f-1)),h+u>=o&&(u=Math.max(0,o-h-1));let l=Math.min(f,Math.max(0,i)),g=Math.min(c,Math.max(0,i-l)),d=Math.min(h,Math.max(0,r)),p=Math.min(u,Math.max(0,r-d)),x=Math.max(0,i-l-g),M=Math.max(0,r-d-p);l+x+g!==i&&(g=Math.max(0,i-l-x)),d+M+p!==r&&(p=Math.max(0,r-d-M));const b=e.scale,w=f*b,v=c*b,E=h*b,H=u*b,D=e.naturalW,V=e.naturalH,$=Math.max(0,(m-f-c)*b),F=Math.max(0,(o-h-u)*b),z=(j,U,T,R,G,q,k,P)=>{T<=0||R<=0||k<=0||P<=0||s.drawImage(e.img,j,U,T,R,n+G,a+q,k,P)},lt=(j,U,T,R,G,q,k,P)=>{const I=new OffscreenCanvas(T/e.scale,R/e.scale),Q=I.getContext("2d",{alpha:!0});Q.imageSmoothingEnabled=!0,Q.imageSmoothingQuality="high",Q.drawImage(e.img,j,U,T,R,0,0,I.width,I.height);const K=s.createPattern(I,"repeat");K&&(s.save(),s.translate(n+G,a+q),s.fillStyle=K,s.fillRect(0,0,k,P),s.restore())};z(0,0,w,E,0,0,l,d),z(D-v,0,v,E,i-g,0,g,d),z(0,V-H,w,H,0,r-p,l,p),z(D-v,V-H,v,H,i-g,r-p,g,p);let C=e.centerMode==="tile"?lt:z;return d>0&&x>0&&e.mode!=="3-part-horizontal"&&C(w,0,$,E,l,0,x,d),p>0&&x>0&&e.mode!=="3-part-horizontal"&&C(w,V-H,$,H,l,r-p,x,p),l>0&&M>0&&e.mode!=="3-part-vertical"&&C(0,E,w,F,0,d,l,M),g>0&&M>0&&e.mode!=="3-part-vertical"&&C(D-v,E,v,F,i-g,d,g,M),x>0&&M>0&&C(w,E,$,F,l,d,x,M),S(t,[t])}};J(Ht);
