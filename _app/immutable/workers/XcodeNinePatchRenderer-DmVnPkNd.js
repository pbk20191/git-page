/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const k=Symbol("Comlink.proxy"),N=Symbol("Comlink.endpoint"),L=Symbol("Comlink.releaseProxy"),E=Symbol("Comlink.finalizer"),x=Symbol("Comlink.thrown"),C=t=>typeof t=="object"&&t!==null||typeof t=="function",_={canHandle:t=>C(t)&&t[k],serialize(t){const{port1:n,port2:s}=new MessageChannel;return H(t,n),[s,[s]]},deserialize(t){return t.start(),F(t)}},D={canHandle:t=>C(t)&&x in t,serialize({value:t}){let n;return t instanceof Error?n={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:n={isError:!1,value:t},[n,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},R=new Map([["proxy",_],["throw",D]]);function V(t,n){for(const s of t)if(n===s||s==="*"||s instanceof RegExp&&s.test(n))return!0;return!1}function H(t,n=globalThis,s=["*"]){n.addEventListener("message",function i(a){if(!a||!a.data)return;if(!V(s,a.origin)){console.warn(`Invalid origin '${a.origin}' for comlink proxy`);return}const{id:r,type:f,path:l}=Object.assign({path:[]},a.data),h=(a.data.argumentList||[]).map(g);let o;try{const c=l.slice(0,-1).reduce((u,p)=>u[p],t),m=l.reduce((u,p)=>u[p],t);switch(f){case"GET":o=m;break;case"SET":c[l.slice(-1)[0]]=g(a.data.value),o=!0;break;case"APPLY":o=m.apply(c,h);break;case"CONSTRUCT":{const u=new m(...h);o=q(u)}break;case"ENDPOINT":{const{port1:u,port2:p}=new MessageChannel;H(t,p),o=G(u,[u])}break;case"RELEASE":o=void 0;break;default:return}}catch(c){o={value:c,[x]:0}}Promise.resolve(o).catch(c=>({value:c,[x]:0})).then(c=>{const[m,u]=M(c);n.postMessage(Object.assign(Object.assign({},m),{id:r}),u),f==="RELEASE"&&(n.removeEventListener("message",i),P(n),E in t&&typeof t[E]=="function"&&t[E]())}).catch(c=>{const[m,u]=M({value:new TypeError("Unserializable return value"),[x]:0});n.postMessage(Object.assign(Object.assign({},m),{id:r}),u)})}),n.start&&n.start()}function $(t){return t.constructor.name==="MessagePort"}function P(t){$(t)&&t.close()}function F(t,n){const s=new Map;return t.addEventListener("message",function(a){const{data:r}=a;if(!r||!r.id)return;const f=s.get(r.id);if(f)try{f(r)}finally{s.delete(r.id)}}),z(t,s,[],n)}function y(t){if(t)throw new Error("Proxy has been released and is not useable")}function I(t){return d(t,new Map,{type:"RELEASE"}).then(()=>{P(t)})}const w=new WeakMap,v="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const n=(w.get(t)||0)-1;w.set(t,n),n===0&&I(t)});function j(t,n){const s=(w.get(n)||0)+1;w.set(n,s),v&&v.register(t,n,t)}function U(t){v&&v.unregister(t)}function z(t,n,s=[],i=function(){}){let a=!1;const r=new Proxy(i,{get(f,l){if(y(a),l===L)return()=>{U(r),I(t),n.clear(),a=!0};if(l==="then"){if(s.length===0)return{then:()=>r};const h=d(t,n,{type:"GET",path:s.map(o=>o.toString())}).then(g);return h.then.bind(h)}return z(t,n,[...s,l])},set(f,l,h){y(a);const[o,c]=M(h);return d(t,n,{type:"SET",path:[...s,l].map(m=>m.toString()),value:o},c).then(g)},apply(f,l,h){y(a);const o=s[s.length-1];if(o===N)return d(t,n,{type:"ENDPOINT"}).then(g);if(o==="bind")return z(t,n,s.slice(0,-1));const[c,m]=T(h);return d(t,n,{type:"APPLY",path:s.map(u=>u.toString()),argumentList:c},m).then(g)},construct(f,l){y(a);const[h,o]=T(l);return d(t,n,{type:"CONSTRUCT",path:s.map(c=>c.toString()),argumentList:h},o).then(g)}});return j(r,t),r}function B(t){return Array.prototype.concat.apply([],t)}function T(t){const n=t.map(M);return[n.map(s=>s[0]),B(n.map(s=>s[1]))]}const A=new WeakMap;function G(t,n){return A.set(t,n),t}function q(t){return Object.assign(t,{[k]:!0})}function M(t){for(const[n,s]of R)if(s.canHandle(t)){const[i,a]=s.serialize(t);return[{type:"HANDLER",name:n,value:i},a]}return[{type:"RAW",value:t},A.get(t)||[]]}function g(t){switch(t.type){case"HANDLER":return R.get(t.name).deserialize(t.value);case"RAW":return t.value}}function d(t,n,s,i){return new Promise(a=>{const r=Y();n.set(r,a),t.start&&t.start(),t.postMessage(Object.assign({id:r},s),i)})}function Y(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const e={naturalW:0,naturalH:0,scale:1,canvasW:0,canvasH:0,insets:{top:0,right:0,bottom:0,left:0},mode:"9-part",centerMode:"stretch"};function O(){if(!e.canvas)throw new Error("Canvas not attached");if(!e.ctx){const t=e.canvas.getContext("2d",{alpha:!0});if(!t)throw new Error("2D context unavailable");e.ctx=t}return e.ctx}function W(){e.img&&(e.canvasW=Math.max(1,Math.round(e.naturalW/e.scale)),e.canvasH=Math.max(1,Math.round(e.naturalH/e.scale)),e.canvas&&(e.canvas.width=e.canvasW,e.canvas.height=e.canvasH),S())}function S(t="right",n="bottom"){e.insets.left=Math.max(0,Math.min(e.insets.left,e.canvasW-1)),e.insets.right=Math.max(0,Math.min(e.insets.right,e.canvasW-1)),e.insets.top=Math.max(0,Math.min(e.insets.top,e.canvasH-1)),e.insets.bottom=Math.max(0,Math.min(e.insets.bottom,e.canvasH-1)),e.insets.left+e.insets.right>=e.canvasW&&(t!=="left"?e.insets.right=Math.max(0,e.canvasW-e.insets.left-1):e.insets.left=Math.max(0,e.canvasW-e.insets.right-1)),e.insets.top+e.insets.bottom>=e.canvasH&&(n!=="bottom"?e.insets.top=Math.max(0,e.canvasH-e.insets.bottom-1):e.insets.bottom=Math.max(0,e.canvasH-e.insets.top-1))}function Q(t,n,s){for(let a=0;a<s;a+=8)for(let r=0;r<n;r+=8)t.fillStyle=(r/8+a/8)%2===0?"#eee":"#ddd",t.fillRect(r,a,8,8)}function b(){const t=O(),{canvasW:n,canvasH:s}=e;t.clearRect(0,0,n,s),Q(t,n,s),e.img&&(t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high",t.drawImage(e.img,0,0,e.naturalW,e.naturalH,0,0,n,s)),t.save(),t.setLineDash([6,4]),t.lineWidth=1,e.mode!=="3-part-vertical"&&(t.strokeStyle="#007aff",t.beginPath(),t.moveTo(e.insets.left,0),t.lineTo(e.insets.left,s),t.moveTo(n-e.insets.right,0),t.lineTo(n-e.insets.right,s),t.stroke()),e.mode!=="3-part-horizontal"&&(t.strokeStyle="#ff3b30",t.beginPath(),t.moveTo(0,e.insets.top),t.lineTo(n,e.insets.top),t.moveTo(0,s-e.insets.bottom),t.lineTo(n,s-e.insets.bottom),t.stroke());const i=e.insets.left,a=e.insets.top,r=Math.max(0,n-e.insets.left-e.insets.right),f=Math.max(0,s-e.insets.top-e.insets.bottom);t.fillStyle="rgba(0, 122, 255, 0.08)",t.fillRect(i,a,r,f),t.fillStyle="#000",t.font="12px system-ui, -apple-system, sans-serif",t.textAlign="left",t.textBaseline="top",t.fillText(`mode=${e.mode}, center=${e.centerMode}, scale=${e.scale}x`,6,6),t.restore()}function X(t,n){return[{e:"left",v:Math.abs(t-e.insets.left)},{e:"right",v:Math.abs(t-(e.canvasW-e.insets.right))},{e:"top",v:Math.abs(n-e.insets.top)},{e:"bottom",v:Math.abs(n-(e.canvasH-e.insets.bottom))}].sort((i,a)=>i.v-a.v)[0].e}const J={async attach(t){e.canvas=t,e.ctx=void 0,O()},async setSource(t,n){e.img&&e.img.close(),e.img=t,e.naturalW=t.width,e.naturalH=t.height,e.scale=n,W(),b()},async setScale(t){e.scale=t,W(),b()},async setMode(t,n){e.mode=t,e.centerMode=n,b()},async setInsets(t,n="right",s="bottom"){e.insets={...e.insets,...t},S(n,s),b()},async queryNearestEdge(t,n){return X(t,n)},async getState(){return{canvasW:e.canvasW,canvasH:e.canvasH,insets:e.insets,scale:e.scale,mode:e.mode,centerMode:e.centerMode,naturalW:e.naturalW,naturalH:e.naturalH}},async buildResizingInfo(t){const n=Math.round(e.naturalW/e.scale)*t,s=Math.round(e.naturalH/e.scale)*t,i=e.insets,a=Math.max(0,n-i.left*t-i.right*t),r=Math.max(0,s-i.top*t-i.bottom*t);return e.mode==="3-part-horizontal"?{mode:"3-part-horizontal",center:{mode:e.centerMode,width:a},"cap-insets":{left:i.left*t,right:i.right*t}}:e.mode==="3-part-vertical"?{mode:"3-part-vertical",center:{mode:e.centerMode,height:r},"cap-insets":{top:i.top*t,bottom:i.bottom*t}}:{mode:"9-part",center:{mode:e.centerMode,width:a,height:r},"cap-insets":{left:i.left*t,right:i.right*t,top:i.top*t,bottom:i.bottom*t}}},async exportAsset(t){const n=await this.buildResizingInfo(1),s=await this.buildResizingInfo(2),i=await this.buildResizingInfo(3),a=new OffscreenCanvas(e.naturalW/e.scale*3,e.naturalH/e.scale*3);let r=a.getContext("2d");r.drawImage(e.img,0,0,e.img.width,e.img.height,0,0,a.width,a.height);const f=await a.convertToBlob({type:"image/png"});a.width=a.width*2/3,a.height=a.height*2/3,r=a.getContext("2d"),r.drawImage(e.img,0,0,e.img.width,e.img.height,0,0,a.width,a.height);const l=await a.convertToBlob({type:"image/png"});a.width/=2,a.height/=2,r=a.getContext("2d"),r.drawImage(e.img,0,0,e.img.width,e.img.height,0,0,a.width,a.height);const h=await a.convertToBlob({type:"image/png"});return{contents:{images:[{filename:`${t}@1x.png`,idiom:"universal",scale:"1x",resizing:n},{filename:`${t}@2x.png`,idiom:"universal",scale:"2x",resizing:s},{filename:`${t}@3x.png`,idiom:"universal",scale:"3x",resizing:i}],info:{version:1,author:"pbk"}},image1x:h,image2x:l,image3x:f}}};H(J);
